name: Debug Bug Tracker Integration

on:
  push:
    branches: [main, master]

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Check secrets availability
        run: |
          echo "Checking GitHub secrets configuration:"
          if [ -n "${{ secrets.BUG_TRACKER_URL }}" ]; then
            echo "✅ BUG_TRACKER_URL is set"
            echo "URL length: $(echo "${{ secrets.BUG_TRACKER_URL }}" | wc -c)"
          else
            echo "❌ BUG_TRACKER_URL is NOT set"
          fi

          if [ -n "${{ secrets.BUG_TRACKER_API_KEY }}" ]; then
            echo "✅ BUG_TRACKER_API_KEY is set"
            echo "API key length: $(echo "${{ secrets.BUG_TRACKER_API_KEY }}" | wc -c)"
          else
            echo "❌ BUG_TRACKER_API_KEY is NOT set"
          fi

          if [ -n "${{ secrets.BUG_TRACKER_PROJECT_ID }}" ]; then
            echo "✅ BUG_TRACKER_PROJECT_ID is set"
            echo "Project ID value: ${{ secrets.BUG_TRACKER_PROJECT_ID }}"
          else
            echo "❌ BUG_TRACKER_PROJECT_ID is NOT set"
          fi

      - name: Test direct access to public URL
        run: |
          PUBLIC_URL="https://4e74a1-3135.d9.code-live.app/dashboard/projects/webhook/00000/to/?bz"
          echo "Testing connection to public bug tracker URL: $PUBLIC_URL"
          curl -s -o /dev/null -w "Connection test status code: %{http_code}\n" \
            --connect-timeout 10 "$PUBLIC_URL" || echo "Connection failed"
        continue-on-error: true

      - name: Create test bug with public URL
        run: |
          PUBLIC_URL="https://4e74a1-3135.d9.code-live.app/dashboard/projects/webhook/00000/to/?bz"
          echo "Attempting to create a test bug directly using public URL:"
          curl -v -X POST "$PUBLIC_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.BUG_TRACKER_API_KEY }}" \
            -d '{
              "projectId": "${{ secrets.BUG_TRACKER_PROJECT_ID }}",
              "commit": "debug-commit",
              "branch": "main",
              "repository": "Testing-Demo",
              "bugTitle": "TEST BUG: Created directly via public URL",
              "testOutput": "VGhpcyBpcyBhIHRlc3QgYnVnIGNyZWF0ZWQgZGlyZWN0bHkgdmlhIHB1YmxpYyBVUkw=",
              "failedTests": "Debug test",
              "failureCount": "1"
            }' 2>&1 | grep -v "Authorization" || echo "Request failed"
        continue-on-error: true
